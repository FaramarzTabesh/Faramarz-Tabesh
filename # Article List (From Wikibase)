import requests
import re

WIKIBASE_API_URL = "https://aogdata.wikibase.cloud/w/api.php"
ARTICLE_LIST_FILE = "Article List (From Wikibase).md"

def get_articles():
    response = requests.get(WIKIBASE_API_URL, {
        "action": "query",
        "list": "allpages",
        "apnamespace": 0,
        "format": "json"
    })
    pages = response.json()["query"]["allpages"]
    
    articles = []
    for page in pages:
        title = page["title"]
        qid = page["title"].split(":")[-1]
        url = f"https://aogdata.wikibase.cloud/wiki/Item:{qid}"
        articles.append((title, url))
    return articles

def generate_markdown_list(articles):
    markdown = ""
    for i, (title, url) in enumerate(articles, 1):
        markdown += f"{i}. [{title}]({url})\n"
    return markdown.strip()

def update_article_list_file(new_content):
    with open(ARTICLE_LIST_FILE, "r", encoding="utf-8") as f:
        content = f.read()

    updated_content = re.sub(
        r"<!-- ARTICLE LIST START -->(.*?)<!-- ARTICLE LIST END -->",
        f"<!-- ARTICLE LIST START -->\n{new_content}\n<!-- ARTICLE LIST END -->",
        content,
        flags=re.DOTALL
    )

    with open(ARTICLE_LIST_FILE, "w", encoding="utf-8") as f:
        f.write(updated_content)

if __name__ == "__main__":
    articles = get_articles()
    article_md = generate_markdown_list(articles)
    update_article_list_file(article_md)
    print(f"âœ… '{ARTICLE_LIST_FILE}' updated with latest article list.")
